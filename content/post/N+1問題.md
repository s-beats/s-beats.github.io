---
title: "N+1問題"
date: 2021-12-21T07:09:59+09:00
draft: true
comments: false
adsence: false
---

**N+1問題**とは1:Nの関係を持つデータを取得する際に、大量のSQLが発行されてパフォーマンスが低下してしまう問題のことを指す。

## 例

複数のユーザー(user)が存在し、それぞれのユーザーは複数の投稿(post)を持つとする。

複数ユーザーを取得し、そのユーザーに紐付く投稿を取得する際に、まず1回目のクエリで複数のユーザー(N件)を取得し、その後にN回のクエリでそれぞれのユーザーに紐付く投稿を取得する。
ユーザー件数が増えるにしたがって**N**の値は大きくなり、発行されるクエリの数が増大しパフォーマンスの低下を引き起こす。
つまり100件のユーザーを返却するのには100回クエリが発行される処理となる。(オーダーn)

この解決策として、**Eager Loading**、**Lazy Loading**という二つの手法がある。

## Eager Loading

今回の例で言うと1回目のクエリで投稿を条件指定なしで取得し、2回目のクエリでN件のユーザーを取得する。
2回のクエリで取得したデータを基にして応答を作成する。

クエリの発行は2回に抑えられる。
紐付くデータ取得を前もって行うという手法である。

## 参考

- https://qiita.com/muroya2355/items/d4eecbe722a8ddb2568b
